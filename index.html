<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>老少咸宜MBTI V4.0测试版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseCore = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'oni-mbti-v4';
        let db, auth;

        // --- 60题库：规范语言、平衡表述、规避评价 ---
        const questions = [
            // Se (外倾感觉：感官、行动)
            { id: 1, func: 'Se', text: '我更喜欢通过直接动手操作来学习新技能，阅读详细的说明书往往让我感到疲劳。' },
            { id: 2, func: 'Se', text: '我很关注物理环境的变化，例如光线强弱或空气流通，这些细节会直接影响我的注意力。' },
            { id: 3, func: 'Se', text: '压力较大时，我倾向于通过体育活动或餐饮享受来放松，而不是进行深度谈话或反思。' },
            { id: 4, func: 'Se', text: '比起探讨抽象的理论或长远规划，我更关心目前能看到并解决的实际问题。' },
            { id: 5, func: 'Se', text: '我不习惯长期从事高度重复的任务，通常需要新鲜的体验或挑战来维持精力。' },
            { id: 6, func: 'Se', text: '在社交场合中，我能迅速观察到现场氛围的变化，并习惯根据当下的情况即兴做出反应。' },
            // Si (内倾感觉：经验、稳定性)
            { id: 7, func: 'Si', text: '如果日常生活习惯被打破，我常感到生理层面的不适，即便这种改变是为了更好的结果。' },
            { id: 8, func: 'Si', text: '我倾向于选择熟悉的食物或消费地点，尝试完全陌生的事物对我来说是一种不必要的消耗。' },
            { id: 9, func: 'Si', text: '我对过去经历中的细节（如当时的光线、气味或对方的衣着）有深刻的记忆，并常以此衡量现状。' },
            { id: 10, func: 'Si', text: '面对新任务时，我习惯优先寻找已有的成熟流程或先例，以确保行动的稳定性。' },
            { id: 11, func: 'Si', text: '我非常看重秩序和归位。如果环境处于杂乱无序的状态，我很难静下心来处理重要工作。' },
            { id: 12, func: 'Si', text: '我对自己身体的细微状态非常敏感，哪部分感到劳累或不适，我通常能第一时间察觉。' },
            // Ne (外倾直觉：发散、联想)
            { id: 13, func: 'Ne', text: '一个新念头的出现常会引起我大量的发散联想，这有时会导致手头的工作因此中断。' },
            { id: 14, func: 'Ne', text: '我更迷恋构思阶段的各种可能性，一旦项目进入长期、枯燥的执行期，我很难维持最初的热情。' },
            { id: 15, func: 'Ne', text: '在对话中，我常能预见对方接下来想表达的内容，并倾向于跳过冗长的陈述直接进入新话题。' },
            { id: 16, func: 'Ne', text: '看到两件看似无关的事物时，我习惯寻找它们之间潜在的逻辑联系或创意点。' },
            { id: 17, func: 'Ne', text: '我更希望生活环境充满变量和选择，如果是按部就班且完全确定的终点，会让我感到压抑。' },
            { id: 18, func: 'Ne', text: '我的兴趣非常广泛，但往往分布在多个不同领域，且每个领域的热度通常只维持一段爆发期。' },
            // Ni (内倾直觉：全局、预判)
            { id: 19, func: 'Ni', text: '有时候我会产生某种强烈的预感。虽然目前缺乏具体的逻辑支撑，但这种确定感会一直伴随我。' },
            { id: 20, func: 'Ni', text: '比起当下的具体收益，我更在乎整个局面的长远走向，这有时会让我显得有些孤傲。' },
            { id: 21, func: 'Ni', text: '我对事物的底层规律有种先觉性判断。面对纷乱的信息，我通常只选择符合我预设模型的部分。' },
            { id: 22, func: 'Ni', text: '我喜欢推敲信息背后的“言外之意”。那些过于直白或碎片化的陈述，反而让我觉得缺乏深度。' },
            { id: 23, func: 'Ni', text: '我追求本质上的突破。如果原有系统逻辑存在缺陷，我倾向于推倒重来，而不是在旧框架上修补。' },
            { id: 24, func: 'Ni', text: '我习惯用高度概括的方式思考。过多的具体细节通常会分散我的精力，甚至干扰我对大方向的判断。' },
            // Te (外倾思考：逻辑、效率)
            { id: 25, func: 'Te', text: '如果项目缺乏明确的阶段性目标和量化指标，我会感到对局势失去了掌控。' },
            { id: 26, func: 'Te', text: '发现原有的方法效率低下时，我会主张建立新的规则，即使这会引发周围人的抵触情绪。' },
            { id: 27, func: 'Te', text: '评价一个人时，我首要参考的是其实际产出的客观价值，而非其投入的感情或主观努力。' },
            { id: 28, func: 'Te', text: '即使方案尚未准备至完美，我也倾向于先行推动，因为停滞带来的损耗对我而言最难接受。' },
            { id: 29, func: 'Te', text: '我习惯管理资源和分配任务。看着混乱的过程变得有序、高效，会让我获得极大的满足感。' },
            { id: 30, func: 'Te', text: '我非常看重时间效率。如果一段社交没有任何实质性目的或产出，我会有强烈的离场冲动。' },
            // Ti (内倾思考：架构、严谨)
            { id: 31, func: 'Ti', text: '我有一套自成体系的逻辑。哪怕是公认的标准，只要我认为其不够严密，我也会拒绝盲从。' },
            { id: 32, func: 'Ti', text: '比起听取现成的结论，我更喜欢独立拆解、重构事物的底层原理，这常让我显得有点执着。' },
            { id: 33, func: 'Ti', text: '我追求表达的准确性。在讨论中，我会忍不住指出对方逻辑中细微的矛盾，无论气氛是否尴尬。' },
            { id: 34, func: 'Ti', text: '我更关心事物内部的运作机制。至于该事物是否被大众认可或实际应用，对我而言并不关键。' },
            { id: 35, func: 'Ti', text: '在没能彻底理清一个问题的内在原理前，我很难开始执行，必须在脑中先建立完整的框架。' },
            { id: 36, func: 'Ti', text: '我享受独立钻研的宁静。外界流行的趋势或观点，通常很难干扰我个人的逻辑分析标准。' },
            // Fe (外倾情感：关系、调和)
            { id: 37, func: 'Fe', text: '我常不由自主地关注集体氛围。如果有人被冷落或环境尴尬，我会有很强烈的去调解的压力。' },
            { id: 38, func: 'Fe', text: '做决策时，我会反复衡量这是否会被周围人接纳。我非常排斥因个人坚持而导致场面破裂。' },
            { id: 39, func: 'Fe', text: '我习惯根据谈话对象的情绪调整自己的语言风格，以此来减少沟通中的摩擦并达成共识。' },
            { id: 40, func: 'Fe', text: '我很容易受到周围情绪场的干扰。在一个充满敌意或负能量的环境里，我很难正常开展工作。' },
            { id: 41, func: 'Fe', text: '我认为维护人际关系的和谐高于坚持某种极端的个人立场。我愿意为此在细枝末节上做出让步。' },
            { id: 42, func: 'Fe', text: '我发现自己经常在不知不觉中承担了安抚他人的角色，这种情感支出常让我感到疲惫。' },
            // Fi (内倾情感：真诚、底线)
            { id: 43, func: 'Fi', text: '我很难掩饰自己内心的反感或不悦。如果不符合我的价值观，我很难表现出虚假的顺从。' },
            { id: 44, func: 'Fi', text: '我的判断准则极其个人化。那些世俗认为“好”或“对”的东西，如果不符合我的内核，我绝不认同。' },
            { id: 45, func: 'Fi', text: '我非常看重内心情感的纯度。对于不够真诚的社交互动，我会感到生理性的厌烦并想主动回避。' },
            { id: 46, func: 'Fi', text: '有些底线我绝不会触碰。哪怕周围所有人都认为那是微不足道的一桩小事。' },
            { id: 47, func: 'Fi', text: '我习惯保护个人的情感私密。只有极少数深度契合的人，才能看到我真实的一面。' },
            { id: 48, func: 'Fi', text: '对我而言，知行合一是生活的前提。如果被迫做了违背自身信念的事，我会陷入极大的心理内耗。' },

            // --- 细分维度 (Subtypes) ---
            // A (利落) vs O (犹豫/周密)
            { id: 49, func: 'Sub_A', text: '一旦初步方案确定，我会倾向于立即行动。相比于延迟交付，我更愿意在执行中纠正偏差。' },
            { id: 50, func: 'Sub_O', text: '在重大决策前，我习惯进行多方对比。这种对潜在风险的担忧，常使我比别人需要更长的观察期。' },
            { id: 51, func: 'Sub_A', text: '我追求决定的利落感。一旦拍板，我就很少回头去质疑当初是否有更好的选择。' },
            { id: 52, func: 'Sub_O', text: '我常在几个方案间反复衡量。由于担心选择了一个就会失去另一个的潜在收益，常感到难以定论。' },
            { id: 53, func: 'Sub_A', text: '处理日常杂事时，我习惯快速交付结果。我不能忍受因追求极致完美而导致进度长期停滞。' },
            { id: 54, func: 'Sub_O', text: '面对重要选择，我更愿意多方咨询并权衡各种可能后果。一个人草率决定会让我感到极不踏实。' },
            // C (高冷/边界) vs H (温和/亲和)
            { id: 55, func: 'Sub_C', text: '在不熟悉的社交环境中，我习惯保持礼貌但疏离的边界感。不习惯过早地展露个人热情。' },
            { id: 56, func: 'Sub_H', text: '即便初次见面，我也能自然地表现出亲和力。我习惯主动缓和气氛，让对话在温和的基调下进行。' },
            { id: 57, func: 'Sub_C', text: '面对他人的主动热情，我本能地需要一段观察期。这种慢热并不是敌意，而是一种防御习惯。' },
            { id: 58, func: 'Sub_H', text: '我习惯在社交中优先释放善意。相比于设立边界，我觉得这种包容性的连接对解决问题更有利。' },
            { id: 60, func: 'Sub_H', text: '我享受温润、无攻击性的相处模式。为了维持这种舒适的氛围，我愿意在表达方式上表现得更委婉。' },
            { id: 59, func: 'Sub_C', text: '有人认为我显得克制或冷淡。其实我只是觉得情感的流露应当非常审慎，不应轻易交付。' }
        ];

        const App = () => {
            const [user, setUser] = useState(null);
            const [step, setStep] = useState('home');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [feedback, setFeedback] = useState("");
            const [submitting, setSubmitting] = useState(false);
            const [sessionId] = useState(crypto.randomUUID());

            useEffect(() => {
                let retryCount = 0;
                const initFirebase = async () => {
                    if (!window.FirebaseCore) {
                        if (retryCount < 5) { retryCount++; setTimeout(initFirebase, 200); }
                        return;
                    }
                    if (!firebaseConfig.apiKey) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FirebaseCore;
                    try {
                        const app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        onAuthStateChanged(auth, setUser);
                    } catch (err) { console.error("Firebase init failed", err); }
                };
                initFirebase();
            }, []);

            const options = [
                { label: '很不符', val: 1, color: 'bg-red-50 text-red-500 hover:bg-red-100' },
                { label: '较不符', val: 2, color: 'bg-orange-50 text-orange-500 hover:bg-orange-100' },
                { label: '一般', val: 3, color: 'bg-gray-100 text-gray-500 hover:bg-gray-200' },
                { label: '较符合', val: 4, color: 'bg-blue-50 text-blue-500 hover:bg-blue-100' },
                { label: '很符合', val: 5, color: 'bg-green-50 text-green-500 hover:bg-green-100' }
            ];

            const handleSelect = async (val) => {
                const newAnswers = { ...answers, [questions[currentIdx].id]: val };
                setAnswers(newAnswers);
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    setStep('loading');
                    await saveTestResult(newAnswers);
                    setTimeout(() => setStep('result'), 1500);
                }
            };

            const saveTestResult = async (finalAnswers) => {
                if (!user || !db) return;
                const resultObj = calculateMBTI(finalAnswers);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'test_results'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            mbtiCode: resultObj.fullCode,
                            scores: resultObj.normalized,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                } catch (e) { }
            };

            const submitFeedback = async () => {
                if (!feedback.trim() || !user || !db) return;
                setSubmitting(true);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'user_feedback'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            content: feedback,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                    setFeedback("感谢您的建议！");
                    setSubmitting(false);
                } catch (e) { setSubmitting(false); }
            };

            const calculateMBTI = (ansMap) => {
                const scores = { Se: 0, Si: 0, Ne: 0, Ni: 0, Te: 0, Ti: 0, Fe: 0, Fi: 0, Sub_A: 0, Sub_O: 0, Sub_C: 0, Sub_H: 0 };
                Object.keys(ansMap).forEach(id => {
                    const q = questions.find(item => item.id === parseInt(id));
                    if (q) scores[q.func] += ansMap[id];
                });

                const normalized = {};
                ['Se', 'Si', 'Ne', 'Ni', 'Te', 'Ti', 'Fe', 'Fi'].forEach(k => {
                    const count = questions.filter(q => q.func === k).length || 1;
                    normalized[k] = Math.round((scores[k] / (count * 5)) * 100);
                });

                const isA = scores.Sub_A >= scores.Sub_O; 
                const isH = scores.Sub_H >= scores.Sub_C;

                const E = normalized.Se + normalized.Ne + normalized.Te + normalized.Fe;
                const I = normalized.Si + normalized.Ni + normalized.Ti + normalized.Fi;
                const S = normalized.Se + normalized.Si;
                const N = normalized.Ne + normalized.Ni;
                const T = normalized.Te + normalized.Ti;
                const F = normalized.Fe + normalized.Fi;
                const J = normalized.Te + normalized.Fe + normalized.Si + normalized.Ni;
                const P = normalized.Ti + normalized.Fi + normalized.Se + normalized.Ne;

                const mbti = (E >= I ? 'E' : 'I') + (S >= N ? 'S' : 'N') + (T >= F ? 'T' : 'F') + (J >= P ? 'J' : 'P');
                const fullCode = `${mbti}-${isA ? 'A' : 'O'}-${isH ? 'H' : 'C'}`;
                
                return { normalized, mbti, fullCode };
            };

            const testResult = useMemo(() => {
                if (step !== 'result') return null;
                return calculateMBTI(answers);
            }, [answers, step]);

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-2 sm:p-4 text-slate-800 tracking-tight">
                    <div className="max-w-lg w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[92vh] max-h-[850px]">
                        
                        <div className="bg-slate-900 py-5 px-8 shrink-0 flex justify-between items-center text-white border-b border-slate-800">
                            <span className="font-bold tracking-wide">老少咸宜 MBTI V4.0</span>
                            {step === 'quiz' && (
                                <span className="text-[10px] bg-indigo-600 px-2 py-1 rounded">
                                    {currentIdx + 1} / {questions.length}
                                </span>
                            )}
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-8">
                            {step === 'home' && (
                                <div className="text-center py-10 space-y-6 animate-fade-in">
                                    <div className="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto text-indigo-600 text-3xl font-black shadow-inner">4.0</div>
                                    <h2 className="text-2xl font-black text-slate-800 tracking-tight">老少咸宜 MBTI V4.0 测试版</h2>
                                    <p className="text-slate-500 text-sm leading-relaxed px-4">
                                        基于 60 项深度维度分析。不预设“正确标准”，量化你感知习惯的原动力。呈现荣格八维能量，并针对<strong>行动风格(A/O)</strong>与<strong>待人温度(H/C)</strong>精准刻画。
                                    </p>
                                    <button onClick={() => setStep('quiz')} className="w-full bg-indigo-600 py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-indigo-100 active:scale-95 transition-all">
                                        开始测试
                                    </button>
                                </div>
                            )}

                            {step === 'quiz' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div className="flex items-center gap-2">
                                        {currentIdx > 0 && <button onClick={() => setCurrentIdx(currentIdx - 1)} className="text-slate-400 text-xs hover:text-indigo-600 transition-colors px-2 py-1">← 返回</button>}
                                        <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                            <div className="bg-indigo-600 h-full transition-all duration-300" style={{ width: `${((currentIdx + 1) / questions.length) * 100}%` }}></div>
                                        </div>
                                    </div>
                                    <h3 className="text-xl font-bold leading-relaxed text-slate-800 min-h-[140px]">
                                        {questions[currentIdx].text}
                                    </h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {options.map((opt) => (
                                            <button key={opt.val} onClick={() => handleSelect(opt.val)} className={`py-4 rounded-2xl font-bold text-sm transition-all active:scale-[0.98] ${opt.color} border border-transparent shadow-sm`}>
                                                {opt.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {step === 'loading' && (
                                <div className="py-24 text-center space-y-6">
                                    <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                                    <h3 className="text-lg font-bold text-slate-800 tracking-tight">正在分析认知底色...</h3>
                                </div>
                            )}

                            {step === 'result' && testResult && (
                                <div className="animate-fade-in space-y-8 pb-10">
                                    <div className="text-center">
                                        <span className="text-6xl font-black text-slate-900 tracking-tighter italic">{testResult.fullCode}</span>
                                        <p className="text-indigo-600 font-bold mt-2 uppercase tracking-widest text-[10px]">深度细分人格编码报告</p>
                                    </div>

                                    <div className="bg-slate-50 p-6 rounded-[2.5rem] space-y-4 border border-slate-100 shadow-sm">
                                        <div className="flex justify-between items-center mb-2 px-1 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                            <span>八维能量分布</span>
                                            <span>中性化习惯精准分析</span>
                                        </div>
                                        <div className="space-y-3">
                                            {Object.keys(testResult.normalized).map(k => (
                                                <div key={k} className="space-y-1">
                                                    <div className="flex justify-between items-center px-1">
                                                        <span className="text-[10px] font-bold text-slate-600">{k}</span>
                                                        <span className="text-[10px] font-mono text-indigo-500 font-bold">{testResult.normalized[k]}%</span>
                                                    </div>
                                                    <div className="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                                                        <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{ width: `${testResult.normalized[k]}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-12 pt-10 border-t border-slate-100 space-y-5">
                                        <div className="flex items-center gap-2 text-slate-800 font-bold text-sm">
                                            <div className="w-1.5 h-4 bg-indigo-600 rounded-full"></div>
                                            优化反馈
                                        </div>
                                        <textarea 
                                            value={feedback}
                                            onChange={(e) => setFeedback(e.target.value)}
                                            placeholder="结果准确吗？哪些题目听着别扭？欢迎留下改进建议..."
                                            className="w-full h-28 p-4 text-sm bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-100 outline-none placeholder:text-slate-300 shadow-inner"
                                        />
                                        <button disabled={submitting} onClick={submitFeedback} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-sm shadow-xl active:scale-95 transition-all disabled:opacity-50">
                                            {submitting ? '发送中...' : (feedback === "感谢您的建议！" ? "提交成功" : "确认提交反馈建议")}
                                        </button>
                                    </div>

                                    <button onClick={() => window.location.reload()} className="w-full py-4 text-indigo-600 font-bold text-xs uppercase tracking-widest border-2 border-indigo-600 rounded-2xl active:bg-indigo-50 transition-colors">
                                        重新测试
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>