<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>oni MBTI v3.0 深度性格测评</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseCore = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'oni-mbti-v3';
        let db, auth;

        // --- 60题库：八维(48) + 决策A/O(6) + 温度C/H(6) ---
        const questions = [
            // Se (1-6)
            { id: 1, func: 'Se', text: '去陌生城市旅游，我更喜欢直接出门乱逛，看到有趣的店就钻进去。' },
            { id: 2, func: 'Se', text: '压力大的时候，去健身房大汗淋漓或者吃顿火锅比找人聊天更管用。' },
            { id: 3, func: 'Se', text: '我能瞬间发现周围环境的小变化，比如同事换了发色或桌上多了一个摆件。' },
            { id: 4, func: 'Se', text: '我不习惯看厚厚的说明书，更愿意直接上手操作，边做边摸索逻辑。' },
            { id: 5, func: 'Se', text: '我很享受那种即兴的户外运动或惊险的娱乐项目带来的快感。' },
            { id: 6, func: 'Se', text: '周围的环境声音或光线稍有变化，我往往是第一个察觉并感到分心的人。' },
            // Si (7-12)
            { id: 7, func: 'Si', text: '出发去远方前，我会反复清点必需品，甚至在心里演练一遍行程。' },
            { id: 8, func: 'Si', text: '我习惯在固定的几家店点熟悉的外卖，尝试完全陌生新菜品让我感到不安。' },
            { id: 9, func: 'Si', text: '我能清晰记得几年前某个特殊日子的细节，甚至是当时的穿着和午餐内容。' },
            { id: 10, func: 'Si', text: '如果日常生活的节奏（比如几点起床、吃饭）被打乱，我会感到非常焦躁。' },
            { id: 11, func: 'Si', text: '做决定时，我更信任自己亲身经历过的教训，而不是所谓的专家理论。' },
            { id: 12, func: 'Si', text: '我的办公桌面和房间通常保持在特定的秩序下，这让我感到安心且高效。' },
            // Ne (13-18)
            { id: 13, func: 'Ne', text: '聊天时，我经常会从一个话题瞬间联想到好几个毫不相关的新点子上。' },
            { id: 14, func: 'Ne', text: '我脑子里总有很多“如果...会怎样”的古怪念头，即便它们并不现实。' },
            { id: 15, func: 'Ne', text: '我常觉得单一的职业路径太无趣，想尝试各种跨度巨大的斜杠生活。' },
            { id: 16, func: 'Ne', text: '看到一个简单的东西，我能迅速联想到它在不同场景下的多种用途。' },
            { id: 17, func: 'Ne', text: '我很享受“头脑风暴”的过程，即使最后并没有产生一个具体的落地方案。' },
            { id: 18, func: 'Ne', text: '我会同时开启好几个兴趣爱好，尽管大多只有短暂的爆发式热情。' },
            // Ni (19-24)
            { id: 19, func: 'Ni', text: '我总能感觉到一段关系中隐藏的危机，即便表面上看起来风平浪静。' },
            { id: 20, func: 'Ni', text: '看悬疑电影时，我经常能在剧情过半时就直觉闪现，猜出幕后黑手。' },
            { id: 21, func: 'Ni', text: '我得出结论的过程很跳跃，经常很难向别人解释我是如何推导出来的。' },
            { id: 22, func: 'Ni', text: '比起眼前的琐碎事务，我更关心三年、五年后我会成为什么样的人。' },
            { id: 23, func: 'Ni', text: '我喜欢探究事物背后的深层含义，总觉得很多巧合其实是规律的体现。' },
            { id: 24, func: 'Ni', text: '比起具体的细节描述，我更擅长捕捉整件事的大致轮廓和未来导向。' },
            // Te (25-30)
            { id: 25, func: 'Te', text: '如果会议偏离了重点且迟迟没有结论，我会忍不住打断并要求做决策。' },
            { id: 26, func: 'Te', text: '我买东西非常看重性价比和功能性，不太会被那些煽情的广告词洗脑。' },
            { id: 27, func: 'Te', text: '如果发现某个办事流程效率极低，我会立即想办法制定一套新规则来优化。' },
            { id: 28, func: 'Te', text: '在评价一个项目时，我首先看实际的产出数据，而不是听讲了多少苦劳。' },
            { id: 29, func: 'Te', text: '我习惯列出每日的计划清单，并以此来严格管理我的任务优先级。' },
            { id: 30, func: 'Te', text: '我比较直接，在指出团队里的逻辑错误时不会考虑太多面子问题。' },
            // Ti (31-36)
            { id: 31, func: 'Ti', text: '面对那种“大家都这么说”的观点，我非得自己查资料证伪了才放心。' },
            { id: 32, func: 'Ti', text: '我喜欢钻研复杂的东西，哪怕是一个冷门的游戏机制我也能研究好几天。' },
            { id: 33, func: 'Ti', text: '我追求表达的极端准确，有时会纠正别人说话中细微的逻辑错误。' },
            { id: 34, func: 'Ti', text: '比起按照手册操作，我更想拆开来看看这个机器内部到底是怎么转的。' },
            { id: 35, func: 'Ti', text: '在没彻底想通一件事的原理之前，我很难强迫自己盲目开始执行。' },
            { id: 36, func: 'Ti', text: '我享受独处思考的宁静，那是我大脑理顺杂乱信息的黄金时间。' },
            // Fe (37-42)
            { id: 37, func: 'Fe', text: '聚会时如果有人被冷落，我会本能地过去找话题，让对方感到自在。' },
            { id: 38, func: 'Fe', text: '我很擅长察言观色，并根据周围人的情绪及时调整自己的说话语气。' },
            { id: 39, func: 'Fe', text: '我发现自己很容易受到集体氛围的影响，大家开心我也就跟着开心。' },
            { id: 40, func: 'Fe', text: '做决策时，我会充分考虑大家的感受，不希望任何一个人感到受委屈。' },
            { id: 41, func: 'Fe', text: '我经常作为团队里的“润滑剂”，处理成员之间的冲突和摩擦。' },
            { id: 42, func: 'Fe', text: '当我能给别人提供实际的情绪安慰时，我会感到非常有成就感。' },
            // Fi (43-48)
            { id: 43, func: 'Fi', text: '即使全世界都不理解，我也希望能坚持做我认为“对”的事情。' },
            { id: 44, func: 'Fi', text: '我很反感虚伪的社交辞令，更看重人与人之间最真实的流露。' },
            { id: 45, func: 'Fi', text: '有些底线我绝不会触碰，哪怕周围所有人都觉得那是一件微不足道的小事。' },
            { id: 46, func: 'Fi', text: '如果某个品牌的理念不符合我的审美或价值，哪怕再流行我也绝不跟风。' },
            { id: 47, func: 'Fi', text: '我的情感世界非常深沉，但我倾向于藏在心底，不喜欢向外人描述。' },
            { id: 48, func: 'Fi', text: '对我来说，“知行合一”最重要。如果做不到，我会产生很强的内心冲突。' },

            // --- 细分维度 (Subtypes) ---
            // A (利落) vs O (犹豫)
            { id: 49, func: 'Sub_A', text: '面对突发的小麻烦，我倾向于立刻决定并行动，而不是反复权衡。' },
            { id: 50, func: 'Sub_O', text: '购买贵重物品前，我通常要对比好几个平台，很难迅速下定决心。' },
            { id: 51, func: 'Sub_A', text: '我做事追求效率，不喜欢在琐碎的选择细节上耗费太多时间。' },
            { id: 52, func: 'Sub_O', text: '做重大决定前，我总觉得信息收集得不够，常因担心出错而犹豫。' },
            { id: 53, func: 'Sub_A', text: '我喜欢那种迅速拍板并进入执行的状态，而不是长时间的反复讨论。' },
            { id: 54, func: 'Sub_O', text: '我发现自己经常在几个选项间反复横跳，很难彻底定下最终方案。' },
            // C (高冷) vs H (温和)
            { id: 55, func: 'Sub_C', text: '在不熟悉的环境中，我习惯保持礼貌但有距离感，不主动展现热情。' },
            { id: 56, func: 'Sub_H', text: '即便第一次见面，我也能自然地释放亲和力，让对方感到轻松。' },
            { id: 57, func: 'Sub_C', text: '朋友常评价我看起来有点“生人勿进”，有一种不容易被打破的边界感。' },
            { id: 58, func: 'Sub_H', text: '我习惯主动表达友好，觉得温和的沟通氛围能让事情进展得更顺利。' },
            { id: 59, func: 'Sub_C', text: '我倾向于保持客观、克制的社交态度，不太习惯表现得过于亲昵。' },
            { id: 60, func: 'Sub_H', text: '我更享受那种温润、包容的交往状态，愿意主动释放善意去破冰。' }
        ];

        const App = () => {
            const [user, setUser] = useState(null);
            const [step, setStep] = useState('home');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [feedback, setFeedback] = useState("");
            const [submitting, setSubmitting] = useState(false);
            const [sessionId] = useState(crypto.randomUUID());

            useEffect(() => {
                let retryCount = 0;
                const initFirebase = async () => {
                    if (!window.FirebaseCore) {
                        if (retryCount < 5) { retryCount++; setTimeout(initFirebase, 200); }
                        return;
                    }
                    if (!firebaseConfig.apiKey) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FirebaseCore;
                    try {
                        const app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        onAuthStateChanged(auth, setUser);
                    } catch (err) { console.error("Firebase init failed", err); }
                };
                initFirebase();
            }, []);

            const options = [
                { label: '很不符', val: 1, color: 'bg-red-50 text-red-500 hover:bg-red-100' },
                { label: '较不符', val: 2, color: 'bg-orange-50 text-orange-500 hover:bg-orange-100' },
                { label: '一般', val: 3, color: 'bg-gray-100 text-gray-500 hover:bg-gray-200' },
                { label: '较符合', val: 4, color: 'bg-blue-50 text-blue-500 hover:bg-blue-100' },
                { label: '很符合', val: 5, color: 'bg-green-50 text-green-500 hover:bg-green-100' }
            ];

            const handleSelect = async (val) => {
                const newAnswers = { ...answers, [questions[currentIdx].id]: val };
                setAnswers(newAnswers);
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    setStep('loading');
                    await saveTestResult(newAnswers);
                    setTimeout(() => setStep('result'), 1500);
                }
            };

            const saveTestResult = async (finalAnswers) => {
                if (!user || !db) return;
                const resultObj = calculateMBTI(finalAnswers);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'test_results'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            mbtiCode: resultObj.fullCode,
                            scores: resultObj.normalized,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                } catch (e) { }
            };

            const submitFeedback = async () => {
                if (!feedback.trim() || !user || !db) return;
                setSubmitting(true);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'user_feedback'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            content: feedback,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                    setFeedback("感谢您的建议！");
                    setSubmitting(false);
                } catch (e) { setSubmitting(false); }
            };

            const calculateMBTI = (ansMap) => {
                const scores = { Se: 0, Si: 0, Ne: 0, Ni: 0, Te: 0, Ti: 0, Fe: 0, Fi: 0, Sub_A: 0, Sub_O: 0, Sub_C: 0, Sub_H: 0 };
                Object.keys(ansMap).forEach(id => {
                    const q = questions.find(item => item.id === parseInt(id));
                    if (q) scores[q.func] += ansMap[id];
                });

                const normalized = {};
                ['Se', 'Si', 'Ne', 'Ni', 'Te', 'Ti', 'Fe', 'Fi'].forEach(k => {
                    const count = questions.filter(q => q.func === k).length || 1;
                    normalized[k] = Math.round((scores[k] / (count * 5)) * 100);
                });

                const isA = scores.Sub_A >= scores.Sub_O; 
                const isH = scores.Sub_H >= scores.Sub_C;

                const E = normalized.Se + normalized.Ne + normalized.Te + normalized.Fe;
                const I = normalized.Si + normalized.Ni + normalized.Ti + normalized.Fi;
                const S = normalized.Se + normalized.Si;
                const N = normalized.Ne + normalized.Ni;
                const T = normalized.Te + normalized.Ti;
                const F = normalized.Fe + normalized.Fi;
                const J = normalized.Te + normalized.Fe + normalized.Si + normalized.Ni;
                const P = normalized.Ti + normalized.Fi + normalized.Se + normalized.Ne;

                const mbti = (E >= I ? 'E' : 'I') + (S >= N ? 'S' : 'N') + (T >= F ? 'T' : 'F') + (J >= P ? 'J' : 'P');
                const fullCode = `${mbti}-${isA ? 'A' : 'O'}-${isH ? 'H' : 'C'}`;
                
                return { normalized, mbti, fullCode };
            };

            const testResult = useMemo(() => {
                if (step !== 'result') return null;
                return calculateMBTI(answers);
            }, [answers, step]);

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-2 sm:p-4 text-slate-800 tracking-tight">
                    <div className="max-w-lg w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[92vh] max-h-[850px]">
                        
                        {/* Header */}
                        <div className="bg-slate-900 py-5 px-8 shrink-0 flex justify-between items-center text-white border-b border-slate-800">
                            <span className="font-bold uppercase tracking-wide">oni MBTI v3.0</span>
                            {step === 'quiz' && (
                                <span className="text-[10px] bg-indigo-600 px-2 py-1 rounded">
                                    {currentIdx + 1} / {questions.length}
                                </span>
                            )}
                        </div>

                        {/* Main Content */}
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-8">
                            {step === 'home' && (
                                <div className="text-center py-10 space-y-6 animate-fade-in">
                                    <div className="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto text-indigo-600 text-3xl font-black italic shadow-inner">oni</div>
                                    <h2 className="text-2xl font-black text-slate-800 tracking-tight">oni 优化迭代版 MBTI</h2>
                                    <p className="text-slate-500 text-sm leading-relaxed px-4">
                                        基于 60 道情境题进行荣格八维能量分析，并引入核心细分：<br/>
                                        <strong>利落(A) / 犹豫(O)</strong> 与 <strong>温和(H) / 高冷(C)</strong>
                                    </p>
                                    <button onClick={() => setStep('quiz')} className="w-full bg-indigo-600 py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-indigo-100 active:scale-95 transition-all">
                                        开始测试
                                    </button>
                                </div>
                            )}

                            {step === 'quiz' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div className="flex items-center gap-2">
                                        {currentIdx > 0 && <button onClick={() => setCurrentIdx(currentIdx - 1)} className="text-slate-400 text-xs hover:text-indigo-600 transition-colors px-2 py-1">← 返回</button>}
                                        <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                            <div className="bg-indigo-600 h-full transition-all duration-300" style={{ width: `${((currentIdx + 1) / questions.length) * 100}%` }}></div>
                                        </div>
                                    </div>
                                    <h3 className="text-xl font-bold leading-relaxed text-slate-800 min-h-[140px]">
                                        {questions[currentIdx].text}
                                    </h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {options.map((opt) => (
                                            <button key={opt.val} onClick={() => handleSelect(opt.val)} className={`py-4 rounded-2xl font-bold text-sm transition-all active:scale-[0.98] ${opt.color} border border-transparent shadow-sm`}>
                                                {opt.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {step === 'loading' && (
                                <div className="py-24 text-center space-y-6">
                                    <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                                    <h3 className="text-lg font-bold text-slate-800">正在分析 60 项情境偏好...</h3>
                                </div>
                            )}

                            {step === 'result' && testResult && (
                                <div className="animate-fade-in space-y-8 pb-10">
                                    <div className="text-center">
                                        <span className="text-6xl font-black text-slate-900 tracking-tighter italic">{testResult.fullCode}</span>
                                        <p className="text-indigo-600 font-bold mt-2 uppercase tracking-widest text-[10px]">深度细分人格编码</p>
                                    </div>

                                    <div className="bg-slate-50 p-6 rounded-[2.5rem] space-y-4 border border-slate-100 shadow-sm">
                                        <div className="flex justify-between items-center mb-2 px-1 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                            <span>八维能量分布</span>
                                            <span>精准度分析</span>
                                        </div>
                                        <div className="space-y-3">
                                            {Object.keys(testResult.normalized).map(k => (
                                                <div key={k} className="space-y-1">
                                                    <div className="flex justify-between items-center px-1">
                                                        <span className="text-[10px] font-bold text-slate-600">{k}</span>
                                                        <span className="text-[10px] font-mono text-indigo-500 font-bold">{testResult.normalized[k]}%</span>
                                                    </div>
                                                    <div className="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                                                        <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{ width: `${testResult.normalized[k]}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-12 pt-10 border-t border-slate-100 space-y-5">
                                        <div className="flex items-center gap-2 text-slate-800 font-bold text-sm">
                                            <div className="w-1.5 h-4 bg-indigo-600 rounded-full"></div>
                                            迭代建议
                                        </div>
                                        <textarea 
                                            value={feedback}
                                            onChange={(e) => setFeedback(e.target.value)}
                                            placeholder="结果准确吗？题目描述是否好懂？欢迎留下建议..."
                                            className="w-full h-28 p-4 text-sm bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-100 outline-none placeholder:text-slate-300 shadow-inner"
                                        />
                                        <button disabled={submitting} onClick={submitFeedback} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-sm shadow-xl active:scale-95 transition-all disabled:opacity-50">
                                            {submitting ? '发送中...' : (feedback === "感谢您的建议！" ? "提交成功" : "确认提交反馈")}
                                        </button>
                                    </div>
                                    <button onClick={() => window.location.reload()} className="w-full py-4 text-indigo-600 font-bold text-xs uppercase tracking-widest border-2 border-indigo-600 rounded-2xl active:bg-indigo-50 transition-colors">
                                        重新测试
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>