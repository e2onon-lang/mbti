<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>优化迭代版 MBTI 测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 将 Firebase 方法挂载到全局，供 Babel 脚本调用
        window.FirebaseCore = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- 配置与初始化 Firebase ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mbti-feedback-app';
        let db, auth;

        // --- 完整题库：60道八维情境题 + 8道 O/H 细分维度题 ---
        const questions = [
            // Se (外倾感觉)
            { id: 1, func: 'Se', text: '去一个新地方旅游，比起查攻略，我更喜欢到那儿以后随性乱逛。' },
            { id: 2, func: 'Se', text: '看到喜欢的零食或新款鞋子，我通常很难忍住不立刻下单尝试。' },
            { id: 3, func: 'Se', text: '我能很快注意到朋友今天换了发色、香水或者是情绪的小波动。' },
            { id: 4, func: 'Se', text: '压力大的时候，比起找人倾诉，我更想去大吃一顿或者疯狂运动。' },
            { id: 5, func: 'Se', text: '比起听枯燥的理论课，我更愿意直接动手操作，在试错中学习。' },
            { id: 6, func: 'Se', text: '我很享受那种肾上腺素飙升的感觉，比如玩过山车或是即兴的户外冒险。' },
            { id: 7, func: 'Se', text: '周围环境的噪音、光线或温度稍有变化，我往往是第一个察觉并感到不适的人。' },
            // Si (内倾感觉)
            { id: 8, func: 'Si', text: '收拾行李时，我会反复确认钥匙和证件，甚至拍张照记录自己带了。' },
            { id: 9, func: 'Si', text: '我习惯在固定的几家店点固定的外卖，尝试新品对我来说有点冒险。' },
            { id: 10, func: 'Si', text: '我能清晰地记得几年前某个特殊日子的细节，甚至是当时的天气和穿着。' },
            { id: 11, func: 'Si', text: '如果日常生活的稳定节奏被突然打乱，我会感到非常焦躁不安。' },
            { id: 12, func: 'Si', text: '做决定时，我更愿意相信自己过去亲身经历过的教训，而不是所谓的专家建议。' },
            { id: 13, func: 'Si', text: '我很看重传统和仪式感，比如过年一定要吃某样菜，或者纪念日一定要有特定流程。' },
            { id: 14, func: 'Si', text: '处理文件或整理房间时，我会强迫自己把东西归位到习惯的地方。' },
            // Ne (外倾直觉)
            { id: 15, func: 'Ne', text: '刷短视频时我经常会从一个科普跳到八卦，最后完全忘了最初要查什么。' },
            { id: 16, func: 'Ne', text: '我脑子里总有很多“如果...会怎样”的古怪念头，即便它们现在看来很不现实。' },
            { id: 17, func: 'Ne', text: '我很怕生活一眼望得到头，总想尝试跨度巨大的职业或生活方式。' },
            { id: 18, func: 'Ne', text: '看到一个简单的东西，我能迅速联想到它在不同场景下的十几种用途。' },
            { id: 19, func: 'Ne', text: '聊天时我经常会即兴抛出新话题，让对话变得跳跃而有趣。' },
            { id: 20, func: 'Ne', text: '我会同时开启好几个兴趣爱好，尽管大多只有三分钟热度。' },
            { id: 21, func: 'Ne', text: '我喜欢通过冷笑话、双关语或脑洞大开的比喻来调节聚会气氛。' },
            // Ni (内倾直觉)
            { id: 22, func: 'Ni', text: '我总能感觉到一段关系里隐藏的危机，即便当事人还没表现出来。' },
            { id: 23, func: 'Ni', text: '看悬疑片时，我经常在剧情过半时就直觉闪现，猜出幕后黑手。' },
            { id: 24, func: 'Ni', text: '我思考问题很跳跃，经常得出结论后却很难向别人解释我是怎么想到的。' },
            { id: 25, func: 'Ni', text: '比起当下的琐碎工作，我更关心三年、五年后我会成为什么样的人。' },
            { id: 26, func: 'Ni', text: '我喜欢探究事物背后的深意，总觉得很多巧合其实是某种规律的体现。' },
            { id: 27, func: 'Ni', text: '我经常会有那种“似曾相识”的预见感，仿佛某些事情注定会发生。' },
            { id: 28, func: 'Ni', text: '比起具体的细节描述，我更擅长捕捉整件事的大致轮廓和未来导向。' },
            // Te (外倾思考)
            { id: 29, func: 'Te', text: '如果项目没有明确的时间表和阶段目标，我会感到非常不安。' },
            { id: 30, func: 'Te', text: '我喜欢列各种清单，看着任务被一个个划掉会给我带来极大的爽感。' },
            { id: 31, func: 'Te', text: '当大家在会上犹豫不决时，我会忍不住跳出来梳理逻辑并督促大家定论。' },
            { id: 32, func: 'Te', text: '我买东西非常看重性价比和实用性，不太会被华丽的营销话术洗脑。' },
            { id: 33, func: 'Te', text: '在评价一个人时，我首先看TA拿出了什么结果，而不是听TA讲了多少苦劳。' },
            { id: 34, func: 'Te', text: '如果发现某个办事流程效率极低，我会立即想办法制定一套新规则。' },
            { id: 35, func: 'Te', text: '我很在乎时间成本，不喜欢为了“维持体面”而进行没有意义的社交寒暄。' },
            // Ti (内倾思考)
            { id: 36, func: 'Ti', text: '面对那种“大家都这么说”的观点，我非得自己查资料证伪了才放心。' },
            { id: 37, func: 'Ti', text: '我喜欢钻研复杂的东西，哪怕是一个冷门的游戏机制我也能研究好几天。' },
            { id: 38, func: 'Ti', text: '我追求表达的极端准确，有时会纠正别人说话中细微的逻辑错误。' },
            { id: 39, func: 'Ti', text: '比起按照手册操作，我更想拆开来看看这个机器内部到底是怎么转的。' },
            { id: 40, func: 'Ti', text: '我有一套高度自洽的个人逻辑，外界的流行观点很难干扰我的独立判断。' },
            { id: 41, func: 'Ti', text: '在没彻底想通一件事的原理之前，我很难强迫自己盲目开始执行。' },
            { id: 42, func: 'Ti', text: '我享受独处思考的宁静，那是我大脑理顺杂乱信息的黄金时间。' },
            // Fe (外倾情感)
            { id: 43, func: 'Fe', text: '聚会时如果有人被冷落，我会本能地过去找话题救场。' },
            { id: 44, func: 'Fe', text: '我非常在意大家对我的看法，如果知道有人讨厌我，我会郁闷很久。' },
            { id: 45, func: 'Fe', text: '做决定时，我会下意识考虑这个举动会不会让身边的朋友感到不适。' },
            { id: 46, func: 'Fe', text: '我很擅长根据对方当下的情绪，灵活切换我的说话语气和内容。' },
            { id: 47, func: 'Fe', text: '当我看到别人受委屈时，即便跟我没关系，我也能瞬间感同身受并想去安慰。' },
            { id: 48, func: 'Fe', text: '我倾向于为了维护群体的和谐，而在某些时候牺牲自己的一点小诉求。' },
            { id: 49, func: 'Fe', text: '我是朋友圈里的“粘合剂”，总想把大家都聚在一起开开心心的。' },
            // Fi (内倾情感)
            { id: 50, func: 'Fi', text: '即使全世界都不理解，我也希望能坚持做我认为“对”的事情。' },
            { id: 51, func: 'Fi', text: '有些底线我绝不会触碰，哪怕周围所有人都觉得那只是一件微不足道的小事。' },
            { id: 52, func: 'Fi', text: '我很反感职场里那些虚伪的客套话，觉得这样沟通非常消耗我的能量。' },
            { id: 53, func: 'Fi', text: '我的心情更像是一种暗流涌动，很难用语言精准地向外人描述。' },
            { id: 54, func: 'Fi', text: '在购买东西时，我只买那种能代表我品味和个性的，绝不随大流。' },
            { id: 55, func: 'Fi', text: '如果我做的事情违背了我的内心价值，我会产生极其强烈的自我厌恶感。' },
            { id: 56, func: 'Fi', text: '比起热闹的聚会，我更喜欢跟一两个能聊灵魂话题的知心朋友深谈。' },
            // 补充平衡题
            { id: 57, func: 'Si', text: '我习惯在做事之前先把所有的工具和材料准备停当。' },
            { id: 58, func: 'Ni', text: '我经常通过一些象征性的符号或是隐喻来思考生活。' },
            { id: 59, func: 'Te', text: '我更喜欢结果明确的短平快任务，而不是需要长期磨洋工的事。' },
            { id: 60, func: 'Fe', text: '我发现自己很容易受到别人好心情的感染，变得非常有活力。' },
            // --- 细分维度 (Subtypes O/H) ---
            { id: 61, func: 'Sub_O', text: '我习惯每天睡前整理好第二天的衣物和工作清单。' },
            { id: 62, func: 'Sub_O', text: '我的电脑文件和手机相册都进行了严格的分类归档。' },
            { id: 63, func: 'Sub_O', text: '我非常讨厌突如其来的临时邀约，这会打乱我的整体计划。' },
            { id: 64, func: 'Sub_O', text: '在处理杂乱信息时，我的第一本能是给它们建立分类框架。' },
            { id: 65, func: 'Sub_H', text: '遭遇突发挫折后，我能迅速调整情绪，不会陷入长时间的内耗。' },
            { id: 66, func: 'Sub_H', text: '在面对重大的最后期限（Deadline）时，我依然能吃得好、睡得香。' },
            { id: 67, func: 'Sub_H', text: '即便在非常忙乱的环境中，我的内心也能维持一种秩序感和宁静。' },
            { id: 68, func: 'Sub_H', text: '我很少因为别人的否定而产生严重的自我怀疑。' }
        ];

        const App = () => {
            const [user, setUser] = useState(null);
            const [step, setStep] = useState('home');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [feedback, setFeedback] = useState("");
            const [submitting, setSubmitting] = useState(false);
            const [sessionId] = useState(crypto.randomUUID());

            // 1. 初始化 Firebase (增加安全检查和重试)
            useEffect(() => {
                let retryCount = 0;
                const initFirebase = async () => {
                    // 检查 window.FirebaseCore 是否已定义
                    if (!window.FirebaseCore) {
                        if (retryCount < 5) {
                            retryCount++;
                            setTimeout(initFirebase, 200); // 延迟重试
                        }
                        return;
                    }

                    if (!firebaseConfig.apiKey) return;

                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FirebaseCore;
                    
                    try {
                        const app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        onAuthStateChanged(auth, setUser);
                    } catch (err) {
                        console.error("Firebase Auth failed", err);
                    }
                };
                initFirebase();
            }, []);

            const options = [
                { label: '很不符', val: 1, color: 'bg-red-50 text-red-500 hover:bg-red-100' },
                { label: '较不符', val: 2, color: 'bg-orange-50 text-orange-500 hover:bg-orange-100' },
                { label: '一般', val: 3, color: 'bg-gray-100 text-gray-500 hover:bg-gray-200' },
                { label: '较符合', val: 4, color: 'bg-blue-50 text-blue-500 hover:bg-blue-100' },
                { label: '很符合', val: 5, color: 'bg-green-50 text-green-500 hover:bg-green-100' }
            ];

            const handleSelect = async (val) => {
                const newAnswers = { ...answers, [questions[currentIdx].id]: val };
                setAnswers(newAnswers);
                
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    setStep('loading');
                    await saveTestResult(newAnswers);
                    setTimeout(() => setStep('result'), 1500);
                }
            };

            const saveTestResult = async (finalAnswers) => {
                if (!user || !db) return;
                const resultObj = calculateMBTI(finalAnswers);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'test_results'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            mbtiCode: resultObj.fullCode,
                            scores: resultObj.normalized,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                } catch (e) { /* silent fail */ }
            };

            const submitFeedback = async () => {
                if (!feedback.trim() || !user || !db) return;
                setSubmitting(true);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'user_feedback'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            content: feedback,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                    setFeedback("感谢您的建议！");
                    setSubmitting(false);
                } catch (e) { setSubmitting(false); }
            };

            const calculateMBTI = (ansMap) => {
                const scores = { Se: 0, Si: 0, Ne: 0, Ni: 0, Te: 0, Ti: 0, Fe: 0, Fi: 0, Sub_O: 0, Sub_H: 0 };
                Object.keys(ansMap).forEach(id => {
                    const q = questions.find(item => item.id === parseInt(id));
                    if (q) scores[q.func] += ansMap[id];
                });

                const normalized = {};
                ['Se', 'Si', 'Ne', 'Ni', 'Te', 'Ti', 'Fe', 'Fi'].forEach(k => {
                    const count = questions.filter(q => q.func === k).length || 1;
                    normalized[k] = Math.round((scores[k] / (count * 5)) * 100);
                });

                // O-H 后缀判定逻辑
                const isO = scores.Sub_O >= 14; 
                const isH = scores.Sub_H >= 14;

                const E = (normalized.Se || 0) + (normalized.Ne || 0) + (normalized.Te || 0) + (normalized.Fe || 0);
                const I = (normalized.Si || 0) + (normalized.Ni || 0) + (normalized.Ti || 0) + (normalized.Fi || 0);
                const S = (normalized.Se || 0) + (normalized.Si || 0);
                const N = (normalized.Ne || 0) + (normalized.Ni || 0);
                const T = (normalized.Te || 0) + (normalized.Ti || 0);
                const F = (normalized.Fe || 0) + (normalized.Fi || 0);
                const J = (normalized.Te || 0) + (normalized.Fe || 0) + (normalized.Si || 0) + (normalized.Ni || 0);
                const P = (normalized.Ti || 0) + (normalized.Fi || 0) + (normalized.Se || 0) + (normalized.Ne || 0);

                const mbti = (E >= I ? 'E' : 'I') + (S >= N ? 'S' : 'N') + (T >= F ? 'T' : 'F') + (J >= P ? 'J' : 'P');
                const fullCode = `${mbti}-${isO ? 'O' : 'F'}-${isH ? 'H' : 'T'}`;
                
                return { normalized, mbti, fullCode };
            };

            const testResult = useMemo(() => {
                if (step !== 'result') return null;
                return calculateMBTI(answers);
            }, [answers, step]);

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-2 sm:p-4 text-slate-800">
                    <div className="max-w-lg w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[92vh] max-h-[850px]">
                        
                        {/* Header */}
                        <div className="bg-slate-900 py-5 px-8 shrink-0 flex justify-between items-center text-white border-b border-slate-800">
                            <span className="font-bold tracking-tight">oni 优化迭代版 MBTI 测试</span>
                            {step === 'quiz' && (
                                <span className="text-[10px] bg-indigo-600 px-2 py-1 rounded">
                                    Q {currentIdx + 1} / {questions.length}
                                </span>
                            )}
                        </div>

                        {/* Content Body */}
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-8">
                            {step === 'home' && (
                                <div className="text-center py-10 space-y-6 animate-fade-in">
                                    <div className="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto text-indigo-600 text-3xl font-black italic">oni</div>
                                    <h2 className="text-2xl font-black text-slate-800">oni 优化迭代版 MBTI 测试</h2>
                                    <p className="text-slate-500 text-sm leading-relaxed px-4">
                                        基于 60 道情境题进行荣格八维能量分析，并引入 <strong>组织习惯(O/F)</strong> 与 <strong>韧性因子(H/T)</strong> 的细分逻辑。
                                    </p>
                                    <button onClick={() => setStep('quiz')} className="w-full bg-indigo-600 py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-indigo-100 active:scale-95 transition-all">
                                        开始探索
                                    </button>
                                </div>
                            )}

                            {step === 'quiz' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div className="flex items-center gap-2">
                                        {currentIdx > 0 && <button onClick={() => setCurrentIdx(currentIdx - 1)} className="text-slate-400 text-xs hover:text-indigo-600 transition-colors">← 返回</button>}
                                        <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden ml-2">
                                            <div className="bg-indigo-600 h-full transition-all duration-300" style={{ width: `${((currentIdx + 1) / questions.length) * 100}%` }}></div>
                                        </div>
                                    </div>
                                    <h3 className="text-xl font-bold leading-relaxed text-slate-800 min-h-[140px]">
                                        {questions[currentIdx].text}
                                    </h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {options.map((opt) => (
                                            <button 
                                                key={opt.val} 
                                                onClick={() => handleSelect(opt.val)} 
                                                className={`py-4 rounded-2xl font-bold text-sm transition-all active:scale-[0.98] ${opt.color} border border-transparent shadow-sm`}
                                            >
                                                {opt.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {step === 'loading' && (
                                <div className="py-24 text-center space-y-6">
                                    <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                                    <h3 className="text-lg font-bold text-slate-800 tracking-tight">正在计算 68 个维度的能量偏好...</h3>
                                </div>
                            )}

                            {step === 'result' && testResult && (
                                <div className="animate-fade-in space-y-8 pb-10">
                                    <div className="text-center">
                                        <span className="text-6xl font-black text-slate-900 tracking-tighter italic">{testResult.fullCode}</span>
                                        <p className="text-indigo-600 font-bold mt-2 uppercase tracking-widest text-[10px]">深度细分人格报告</p>
                                    </div>

                                    <div className="bg-slate-50 p-6 rounded-[2.5rem] space-y-4 border border-slate-100">
                                        <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">荣格八维能量分布</h4>
                                        <div className="space-y-3">
                                            {Object.keys(testResult.normalized).map(k => (
                                                <div key={k} className="flex items-center gap-3">
                                                    <span className="text-[10px] font-bold w-12 text-slate-600">{k}</span>
                                                    <div className="flex-1 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                                        <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{ width: `${testResult.normalized[k]}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-12 pt-10 border-t border-slate-100 space-y-5">
                                        <div className="flex items-center gap-2 text-slate-800 font-bold text-sm">
                                            <div className="w-1.5 h-4 bg-indigo-600 rounded-full"></div>
                                            优化建议反馈
                                        </div>
                                        <p className="text-xs text-slate-400">为了让测试更准，欢迎指出题目中难以理解或不符直觉的地方：</p>
                                        <textarea 
                                            value={feedback}
                                            onChange={(e) => setFeedback(e.target.value)}
                                            placeholder="例如：第 12 题描述太模糊..."
                                            className="w-full h-28 p-4 text-sm bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-100 outline-none placeholder:text-slate-300"
                                        />
                                        <button 
                                            disabled={submitting}
                                            onClick={submitFeedback}
                                            className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-sm shadow-xl active:scale-95 transition-all disabled:opacity-50"
                                        >
                                            {submitting ? '提交中...' : (feedback === "感谢您的建议！" ? "已提交" : "提交反馈建议")}
                                        </button>
                                    </div>

                                    <button onClick={() => window.location.reload()} className="w-full py-4 text-indigo-600 font-bold text-xs uppercase tracking-[0.2em] border-2 border-indigo-600 rounded-2xl active:bg-indigo-50 transition-colors">
                                        重新测试
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>