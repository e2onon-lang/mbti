<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>老少咸宜MBTI V4.0测试版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseCore = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'oni-mbti-v4';
        let db, auth;

        // --- 60题库：去道德化、全年龄段友好描述 ---
        const questions = [
            // Se (1-6)
            { id: 1, func: 'Se', text: '去陌生环境时，我习惯四处走走看看，摸摸实物来熟悉这里。' },
            { id: 2, func: 'Se', text: '身体是否舒服（比如椅子硬不硬、屋里热不热）会直接影响我干活的劲头。' },
            { id: 3, func: 'Se', text: '我能很快发现别人说话时表情的一点点变化，或者语气里的不自然。' },
            { id: 4, func: 'Se', text: '我习惯在动手做的过程中发现问题，而不是在那干想半天。' },
            { id: 5, func: 'Se', text: '我不喜欢一直聊大道理，更想看到实际的行动或者具体的成果。' },
            { id: 6, func: 'Se', text: '即使人很多，我也能一眼发现谁换了新衣服或者谁今天不太高兴。' },
            // Si (7-12)
            { id: 7, func: 'Si', text: '如果事情没按以前习惯的节奏走，即使结果没变，我心里也会有点别扭。' },
            { id: 8, func: 'Si', text: '我喜欢留着有纪念意义的老物件，或者翻看旧相片来回味过去。' },
            { id: 9, func: 'Si', text: '遇到新麻烦，我会先想想以前有没有遇到过类似的事，按老经验来办。' },
            { id: 10, func: 'Si', text: '我对自己身体的小动静很敏感，比如哪儿不舒服了能马上感觉得到。' },
            { id: 11, func: 'Si', text: '有规矩、有计划的工作环境让我更安心，太随意的安排会让我手足无措。' },
            { id: 12, func: 'Si', text: '我记得住很久以前的琐碎小事，比如那会儿的一个味道或者是当时的光亮。' },
            // Ne (13-18)
            { id: 13, func: 'Ne', text: '我经常因为看到一个东西产生很多联想，结果把手头该干的事给忘了。' },
            { id: 14, func: 'Ne', text: '我想象各种可能性的劲头很大，可一旦事情进入磨人的执行阶段，我就容易没兴趣。' },
            { id: 15, func: 'Ne', text: '聊天时，我经常能猜到对方接下来要说什么，然后忍不住想换个新话题。' },
            { id: 16, func: 'Ne', text: '看到两样完全没关系的东西，我总爱琢磨它们之间是不是有什么关联。' },
            { id: 17, func: 'Ne', text: '我希望生活里多点意外的惊喜，而不是天天都过得一模一样。' },
            { id: 18, func: 'Ne', text: '我发现自己经常在这儿试一下、那儿玩一下，很难长时间只干一件事。' },
            // Ni (19-24)
            { id: 19, func: 'Ni', text: '有时候我能预感一件事会怎么发展，可真要解释为什么，我也说不上来。' },
            { id: 20, func: 'Ni', text: '比起眼前的这点好处，我更在意一个项目或一段关系长期会变成什么样。' },
            { id: 21, func: 'Ni', text: '我经常觉得眼下的事儿好像以前在梦里或者在哪儿预演过一样。' },
            { id: 22, func: 'Ni', text: '看书或看戏时，我喜欢琢磨那些没说明白的深意，而不是只看热闹。' },
            { id: 23, func: 'Ni', text: '比起修修补补，我更想弄出一套新法子，让这种麻烦以后再也别发生。' },
            { id: 24, func: 'Ni', text: '我习惯看大局、抓重点。细节太多了，反而会让我看不清事情的本质。' },
            // Te (25-30)
            { id: 25, func: 'Te', text: '我喜欢用看得见的数据或者进度条来衡量事情办得怎么样，省得扯皮。' },
            { id: 26, func: 'Te', text: '如果发现干活法子太慢，我会直接定个新规矩，哪怕别人觉得我太强势。' },
            { id: 27, func: 'Te', text: '评价一个人时，我主要看他最后拿出了什么成绩，而不是听他说了多少辛苦。' },
            { id: 28, func: 'Te', text: '即使还没准备到十全十美，我也想先干起来，停在那儿不动让我最难受。' },
            { id: 29, func: 'Te', text: '在大家伙里，我更愿意当那个分任务、盯进展的人，这让我心里踏实。' },
            { id: 30, func: 'Te', text: '我很在意时间。要是大家聚在一起光闲聊没正事，我会想早点儿走。' },
            // Ti (31-36)
            { id: 31, func: 'Ti', text: '我有自己的一套逻辑。即使别人都说对，只要我觉得道理不通，我就不干。' },
            { id: 32, func: 'Ti', text: '我喜欢把复杂的道理拆开了揉碎了想，这比直接听个结论要有意思得多。' },
            { id: 33, func: 'Ti', text: '吵架或者讨论时，我能很快听出对方话里的毛病，哪怕这跟心情没关系。' },
            { id: 34, func: 'Ti', text: '比起干活本身，我更想弄明白这东西背后的原理到底是怎么一回事。' },
            { id: 35, func: 'Ti', text: '我会为了一个词用得准不准跟人磨半天，因为我觉得说得糊涂太难受。' },
            { id: 36, func: 'Ti', text: '我爱一个人静静地琢磨事。外面流行什么法子，通常影响不到我的主意。' },
            // Fe (37-42)
            { id: 37, func: 'Fe', text: '人多的时候，我会不由自主地操心大家高不高兴，有时候自己也觉得累。' },
            { id: 38, func: 'Fe', text: '拿主意时，我会反复想这事儿会不会让谁心里不舒坦，哪怕道理上没错。' },
            { id: 39, func: 'Fe', text: '我很会看人下菜碟（褒义），跟不同的人说话我会调整自己的口气。' },
            { id: 40, func: 'Fe', text: '我很容易受周围人的情绪影响。要是大家都在发牢骚，我就没法静心想事。' },
            { id: 41, func: 'Fe', text: '我觉得保住大家的和气，比自己非要说个大实话要更要紧。' },
            { id: 42, func: 'Fe', text: '我发现自己老是在大伙儿中间充当和事佬，劝劝这个、说说那个。' },
            // Fi (43-48)
            { id: 43, func: 'Fi', text: '我宁愿自己一个人呆着，也不想为了让大家高兴而装出一副开心的样子。' },
            { id: 44, func: 'Fi', text: '我有自己的活法。大家都说“好”的东西，要是跟我心里想的不一样，我也不稀罕。' },
            { id: 45, func: 'Fi', text: '我心里的事儿只爱跟极少数交心的人说。外人很难看出我到底在想什么。' },
            { id: 46, func: 'Fi', text: '只要我觉得这事儿办得“心虚”，哪怕道理上赚便宜，我也绝对不干。' },
            { id: 47, func: 'Fi', text: '我特别看重一个人是不是真诚。要是谁跟我套近乎、演戏，我本能地就想躲。' },
            { id: 48, func: 'Fi', text: '对我来说，做人得对得起自个儿。要是被迫干了违心的事，我会难受好久。' },

            // --- 细分维度 (Subtypes) ---
            // A (利落) vs O (犹豫)
            { id: 49, func: 'Sub_A', text: '哪怕主意还没想透，我也想先定下来去干。我不怕做错，就怕没准主意。' },
            { id: 50, func: 'Sub_O', text: '买个大件或者定个大事，我得翻来覆去想好几天，生怕落了什么没考虑到。' },
            { id: 51, func: 'Sub_A', text: '拿了主意我就不爱回头。对我来说，定下来往前走，比老在那比对强。' },
            { id: 52, func: 'Sub_O', text: '我发现自己在几个主意中间老是摇摆，总觉得选了这个就会耽误了那个。' },
            { id: 53, func: 'Sub_A', text: '处理杂事儿我习惯一剪子下去快点干完，不喜欢为了求完美而耽误功夫。' },
            { id: 54, func: 'Sub_O', text: '大事临头，我爱多问问旁人的主意，总觉得一个人想不稳当。' },
            // C (高冷) vs H (温和)
            { id: 55, func: 'Sub_C', text: '跟不太熟的人，我习惯客客气气但保持点距离，不太会一下子就表现得很亲热。' },
            { id: 56, func: 'Sub_H', text: '哪怕是头一回见面，我也能跟人家热络起来，让对方觉得我这人挺好打交道。' },
            { id: 57, func: 'Sub_C', text: '即使人家对我挺热情，我也得先在心里观察观察，慢热是我的常态。' },
            { id: 58, func: 'Sub_H', text: '我挺能体会别人的那种拘束感，会主动找话头儿让人家别太尴尬。' },
            { id: 59, func: 'Sub_C', text: '有人说我这人看起来有点淡，其实我只是觉得交情没到那份儿上，不用太夸张。' },
            { id: 60, func: 'Sub_H', text: '我喜欢那种和和气气、没火药味的相处法，甚至愿意为此在说话上让着点儿。' }
        ];

        const App = () => {
            const [user, setUser] = useState(null);
            const [step, setStep] = useState('home');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [feedback, setFeedback] = useState("");
            const [submitting, setSubmitting] = useState(false);
            const [sessionId] = useState(crypto.randomUUID());

            useEffect(() => {
                let retryCount = 0;
                const initFirebase = async () => {
                    if (!window.FirebaseCore) {
                        if (retryCount < 5) { retryCount++; setTimeout(initFirebase, 200); }
                        return;
                    }
                    if (!firebaseConfig.apiKey) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FirebaseCore;
                    try {
                        const app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        onAuthStateChanged(auth, setUser);
                    } catch (err) { console.error("Firebase init failed", err); }
                };
                initFirebase();
            }, []);

            const options = [
                { label: '很不符', val: 1, color: 'bg-red-50 text-red-500 hover:bg-red-100' },
                { label: '较不符', val: 2, color: 'bg-orange-50 text-orange-500 hover:bg-orange-100' },
                { label: '一般', val: 3, color: 'bg-gray-100 text-gray-500 hover:bg-gray-200' },
                { label: '较符合', val: 4, color: 'bg-blue-50 text-blue-500 hover:bg-blue-100' },
                { label: '很符合', val: 5, color: 'bg-green-50 text-green-500 hover:bg-green-100' }
            ];

            const handleSelect = async (val) => {
                const newAnswers = { ...answers, [questions[currentIdx].id]: val };
                setAnswers(newAnswers);
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    setStep('loading');
                    await saveTestResult(newAnswers);
                    setTimeout(() => setStep('result'), 1500);
                }
            };

            const saveTestResult = async (finalAnswers) => {
                if (!user || !db) return;
                const resultObj = calculateMBTI(finalAnswers);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'test_results'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            mbtiCode: resultObj.fullCode,
                            scores: resultObj.normalized,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                } catch (e) { }
            };

            const submitFeedback = async () => {
                if (!feedback.trim() || !user || !db) return;
                setSubmitting(true);
                try {
                    await window.FirebaseCore.addDoc(
                        window.FirebaseCore.collection(db, 'artifacts', appId, 'public', 'data', 'user_feedback'),
                        {
                            userId: user.uid,
                            sessionId: sessionId,
                            content: feedback,
                            timestamp: window.FirebaseCore.serverTimestamp()
                        }
                    );
                    setFeedback("感谢您的建议！");
                    setSubmitting(false);
                } catch (e) { setSubmitting(false); }
            };

            const calculateMBTI = (ansMap) => {
                const scores = { Se: 0, Si: 0, Ne: 0, Ni: 0, Te: 0, Ti: 0, Fe: 0, Fi: 0, Sub_A: 0, Sub_O: 0, Sub_C: 0, Sub_H: 0 };
                Object.keys(ansMap).forEach(id => {
                    const q = questions.find(item => item.id === parseInt(id));
                    if (q) scores[q.func] += ansMap[id];
                });

                const normalized = {};
                ['Se', 'Si', 'Ne', 'Ni', 'Te', 'Ti', 'Fe', 'Fi'].forEach(k => {
                    const count = questions.filter(q => q.func === k).length || 1;
                    normalized[k] = Math.round((scores[k] / (count * 5)) * 100);
                });

                const isA = scores.Sub_A >= scores.Sub_O; 
                const isH = scores.Sub_H >= scores.Sub_C;

                const E = normalized.Se + normalized.Ne + normalized.Te + normalized.Fe;
                const I = normalized.Si + normalized.Ni + normalized.Ti + normalized.Fi;
                const S = normalized.Se + normalized.Si;
                const N = normalized.Ne + normalized.Ni;
                const T = normalized.Te + normalized.Ti;
                const F = normalized.Fe + normalized.Fi;
                const J = normalized.Te + normalized.Fe + normalized.Si + normalized.Ni;
                const P = normalized.Ti + normalized.Fi + normalized.Se + normalized.Ne;

                const mbti = (E >= I ? 'E' : 'I') + (S >= N ? 'S' : 'N') + (T >= F ? 'T' : 'F') + (J >= P ? 'J' : 'P');
                const fullCode = `${mbti}-${isA ? 'A' : 'O'}-${isH ? 'H' : 'C'}`;
                
                return { normalized, mbti, fullCode };
            };

            const testResult = useMemo(() => {
                if (step !== 'result') return null;
                return calculateMBTI(answers);
            }, [answers, step]);

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-2 sm:p-4 text-slate-800 tracking-tight">
                    <div className="max-w-lg w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[92vh] max-h-[850px]">
                        
                        <div className="bg-slate-900 py-5 px-8 shrink-0 flex justify-between items-center text-white border-b border-slate-800">
                            <span className="font-bold tracking-wide">老少咸宜 MBTI V4.0</span>
                            {step === 'quiz' && (
                                <span className="text-[10px] bg-indigo-600 px-2 py-1 rounded">
                                    {currentIdx + 1} / {questions.length}
                                </span>
                            )}
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-8">
                            {step === 'home' && (
                                <div className="text-center py-10 space-y-6 animate-fade-in">
                                    <div className="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto text-indigo-600 text-3xl font-black shadow-inner">4.0</div>
                                    <h2 className="text-2xl font-black text-slate-800 tracking-tight">老少咸宜 MBTI V4.0 测试版</h2>
                                    <p className="text-slate-500 text-sm leading-relaxed px-4">
                                        基于 60 项日常习惯进行深度分析。不仅呈现荣格八维能量，更针对<strong>行动利落度(A/O)</strong>与<strong>待人温度(H/C)</strong>进行精细刻画。
                                    </p>
                                    <button onClick={() => setStep('quiz')} className="w-full bg-indigo-600 py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-indigo-100 active:scale-95 transition-all">
                                        开始测试
                                    </button>
                                </div>
                            )}

                            {step === 'quiz' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div className="flex items-center gap-2">
                                        {currentIdx > 0 && <button onClick={() => setCurrentIdx(currentIdx - 1)} className="text-slate-400 text-xs hover:text-indigo-600 transition-colors px-2 py-1">← 返回</button>}
                                        <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                            <div className="bg-indigo-600 h-full transition-all duration-300" style={{ width: `${((currentIdx + 1) / questions.length) * 100}%` }}></div>
                                        </div>
                                    </div>
                                    <h3 className="text-xl font-bold leading-relaxed text-slate-800 min-h-[140px]">
                                        {questions[currentIdx].text}
                                    </h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {options.map((opt) => (
                                            <button key={opt.val} onClick={() => handleSelect(opt.val)} className={`py-4 rounded-2xl font-bold text-sm transition-all active:scale-[0.98] ${opt.color} border border-transparent shadow-sm`}>
                                                {opt.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {step === 'loading' && (
                                <div className="py-24 text-center space-y-6">
                                    <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                                    <h3 className="text-lg font-bold text-slate-800">正在分析您的性格底色...</h3>
                                </div>
                            )}

                            {step === 'result' && testResult && (
                                <div className="animate-fade-in space-y-8 pb-10">
                                    <div className="text-center">
                                        <span className="text-6xl font-black text-slate-900 tracking-tighter italic">{testResult.fullCode}</span>
                                        <p className="text-indigo-600 font-bold mt-2 uppercase tracking-widest text-[10px]">深度细分人格编码报告</p>
                                    </div>

                                    <div className="bg-slate-50 p-6 rounded-[2.5rem] space-y-4 border border-slate-100 shadow-sm">
                                        <div className="flex justify-between items-center mb-2 px-1 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                            <span>八维能量分布</span>
                                            <span>日常习惯精准分析</span>
                                        </div>
                                        <div className="space-y-3">
                                            {Object.keys(testResult.normalized).map(k => (
                                                <div key={k} className="space-y-1">
                                                    <div className="flex justify-between items-center px-1">
                                                        <span className="text-[10px] font-bold text-slate-600">{k}</span>
                                                        <span className="text-[10px] font-mono text-indigo-500 font-bold">{testResult.normalized[k]}%</span>
                                                    </div>
                                                    <div className="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                                                        <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{ width: `${testResult.normalized[k]}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-12 pt-10 border-t border-slate-100 space-y-5">
                                        <div className="flex items-center gap-2 text-slate-800 font-bold text-sm">
                                            <div className="w-1.5 h-4 bg-indigo-600 rounded-full"></div>
                                            优化反馈
                                        </div>
                                        <textarea 
                                            value={feedback}
                                            onChange={(e) => setFeedback(e.target.value)}
                                            placeholder="结果准确吗？哪些题目听着别扭？欢迎留下改进建议..."
                                            className="w-full h-28 p-4 text-sm bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-100 outline-none placeholder:text-slate-300 shadow-inner"
                                        />
                                        <button disabled={submitting} onClick={submitFeedback} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-sm shadow-xl active:scale-95 transition-all disabled:opacity-50">
                                            {submitting ? '发送中...' : (feedback === "感谢您的建议！" ? "提交成功" : "确认提交反馈建议")}
                                        </button>
                                    </div>

                                    <button onClick={() => window.location.reload()} className="w-full py-4 text-indigo-600 font-bold text-xs uppercase tracking-widest border-2 border-indigo-600 rounded-2xl active:bg-indigo-50 transition-colors">
                                        重新测试
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>